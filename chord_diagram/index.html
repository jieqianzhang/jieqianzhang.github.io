<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
</head>
<title>Google Chord Diagram</title>
<style>

body{
    font-family: 'Roboto', sans-serif;
    pointer-events: all;
    font-size:20px;
}

#round circle {
    fill: none;
}

path.chord {
    stroke: #c4c3c1;
    stroke-width: .25px;
    opacity: 0.8;
}

#round:hover path.fade {
    -webkit-transition: opacity 0.2s;
    -moz-transition: opacity 0.2s;
    -ms-transition:opacity 0.2s;
    transition: opacity 0.2s;
    opacity:0; 
}

</style>

<body>

    <div id="graphic"></div>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script>


    function drawGraphic() {

        var width = 720,
            height = 720,
            outerRadius = Math.min(width, height) / 2 - 60,
            innerRadius = outerRadius - 25;

        var arc = d3.svg.arc()
            .innerRadius(innerRadius)
            .outerRadius(outerRadius);

        var layout = d3.layout.chord()
            .padding(.04)
            .sortSubgroups(d3.descending);

        var path = d3.svg.chord()
            .radius(innerRadius - 5);

        var svg = d3.select("#graphic").append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(responsivefy)
            .append("g")
            .attr("id", "round")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

       var circle = svg.append("circle")
            .attr("r", outerRadius);

        
       queue()
        .defer(d3.json, "matrix.json")
        .defer(d3.csv, "candidates.csv")
        .await(ready);


       function ready(error, matrix, candidates) {
                
                layout.matrix(matrix);

                // create a group for each candidate
                var group = svg.selectAll(".group")
                    .data(layout.groups)
                    .enter().append("g")
                    .attr("class", "group")
                    .on("mouseover", mouseover)
                    .on("mouseout",mouseout);               

                // Add the group arc for each candidate
                var groupPath = group.append("path")
                    .attr("id", function(d, i) {
                        return "group" + i;
                    })
                    .attr("d", arc)
                    .style("fill", function(d, i) {
                        // console.log(i)
                        return candidates[i].color;
                    })
                    .style("opacity",".8");


                
                // Add the name of each candidate
                var groupText = group.append("text")
                    .attr("dx", "140")
                    .attr("dy","-20")
                    .style("text-anchor", "middle");

                groupText.append("textPath")
                    .attr("xlink:href", function(d, i) { return "#group" + i; })
                    .text(function(d, i) { return candidates[i].name; })
                    .style("fill", function(d, i) { return candidates[i].color; });

                //Add ticks to show percentage

                var ticks = svg.append("g").selectAll("g")
                    .data(layout.groups)
                    .enter().append("g").selectAll("g")
                    .data(groupTicks)
                    .enter().append("g")
                    .attr("transform", function(d) {
                        return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" + "translate(" + outerRadius + ",0)";
                    });

                ticks.append("line")
                    .attr("x1", 1)
                    .attr("y1", 0)
                    .attr("x2", 5)
                    .attr("y2", 0)
                    .style("stroke", "#c4c3c1");


                function groupTicks(d) {
                    var k = (d.endAngle - d.startAngle) / d.value;
                    return d3.range(0, d.value, 10).map(function(v, i) {
                        return {
                            angle: v * k + d.startAngle
                        };
                    });
                }


                //Add the chords.
                var chord = svg.selectAll(".chord")
                    .data(layout.chords)
                    .enter().append("path")
                    .attr("class", "chord")
                    .style("fill", function(d) {
                        return candidates[d.source.index].color;
                    })
                    .attr("d", path);


                //Add the mouseover interactive action 

                function mouseover(d, i) {

                    // svg.selectAll("text")
                    //     .remove();

                    // get the name of the candidate the user hovered over on
                
                    // $(".group").on("mouseover",function(){

                    // var thisCandidate = $(this).text(); 

                    // console.log(thisCandidate)

                    // var groupText = group.append("text")
                    // .attr("dx", "140")
                    // .attr("dy","-20")
                    // .style("text-anchor", "middle");

                    // groupText.append("textPath")
                    // .attr("xlink:href", function(d, i) { return "#group" + i; })
                    // .text(function(d, i) { 
                    //     if (candidates[i]["Joe Biden"] === "0") {
                    //         return candidates[i].name;
                    //     }else{
                    //     return candidates[i]["Joe Biden"] + ". " + candidates[i].name; }
                    //     })
                    // .style("fill", function(d, i) { return candidates[i].color; });

                    svg.selectAll(".chord")
                    .transition()
                    .duration(200)
                    .style("fill", "#455A64");
       


                    chord.classed("fade", function(p) {
                        return p.source.index != i && p.target.index != i;
                    });

                  // });

                };

                function mouseout(d,i){

                    svg.selectAll(".chord")
                    .transition()
                    .duration(200)
                    .style("fill", function(d) {
                        return candidates[d.source.index].color;
                    });
                

                    // svg.selectAll("text")
                    //     .remove();

                    // var groupText = group.append("text")
                    // .attr("dx", "140")
                    // .attr("dy","-20")
                    // .style("text-anchor", "middle");

                    // groupText.append("textPath")
                    // .attr("xlink:href", function(d, i) { return "#group" + i; })
                    // .text(function(d, i) { return candidates[i].name; })
                    // .style("fill", function(d, i) { return candidates[i].color; });
                };
    
        };

        function responsivefy(svg) {

            var container = d3.select(svg.node().parentNode),
                width = parseInt(svg.style("width")),
                height = parseInt(svg.style("height")),
                aspect = width / height;

            svg.attr("viewBox", "0 0 " + width + " " + height)
                .attr("perserveAspectRatio", "xMinYMid")
                .call(resize);

            d3.select(window).on("resize." + container.attr("#graphic"), resize);

            function resize() {
                var targetWidth = parseInt(container.style("width"));
                svg.attr("width", targetWidth * 0.55);
                svg.attr("height", Math.round(targetWidth / aspect * 0.55));
            }
        }

    }

    </script>
</body>

    <script>
    drawGraphic()
    </script>